<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Overview - Elm-MicroScheme</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Overview";
        var mkdocs_page_input_path = "overview.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Elm-MicroScheme
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../about/">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Overview</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#expr-type">Expr Type</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#parser">Parser</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#eval">Eval</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#interpreter">Interpreter</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#frames-and-environments">Frames and Environments</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#numbers">Numbers</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../notes/">Notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Mkdocs</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Elm-MicroScheme</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Overview</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="overview">Overview</h1>
<h2 id="expr-type">Expr Type</h2>
<p>The Expr type is define in module <code>Expr</code>:</p>
<pre><code class="language-elm">
type Expr
    = Z Int
    | F Float
    | B Bool
    | Str String
    | Sym String
    | L (List Expr)
    | Pair Expr Expr
    | Lambda Expr Expr
    | Define Expr Expr
    | If Expr Expr Expr

</code></pre>
<h2 id="parser">Parser</h2>
<pre><code class="language-text">parse : Frame -&gt; String -&gt; Result (List P.DeadEnd) Expr
parse table str =
    P.run exprParser str |&gt; Result.map (Environment.applyFrame table)
</code></pre>
<p>The first argument of <code>parse</code> is the root frame, which
is used to map certain values to symbols, e.g.,
<code>Str "+"</code> to <code>Sym "+"</code>.  Thus we have</p>
<pre><code class="language-elm">&gt; import MicroScheme.Parser exposing(parse)
&gt; import MicroScheme.Init exposing(rootFrame)

&gt; parse rootFrame &quot;(+ 1 2)&quot;
Ok (L [Sym &quot;+&quot;,Z 1,Z 2])

</code></pre>
<h2 id="eval">Eval</h2>
<p>The module <code>Eval</code> exports just one function,</p>
<pre><code class="language-elm">eval : Environment -&gt; Expr -&gt; Result EvalError Expr
eval env expr =
    evalResult env (Ok expr)
</code></pre>
<p>It calls <code>evalResult</code>, which is a long exercise
in pattern-matching:</p>
<pre><code class="language-elm">evalResult : Environment -&gt; Result EvalError Expr -&gt; Result EvalError Expr
evalResult env resultExpr =
    case resultExpr of
        Err error -&gt;
            Err error

        Ok expr -&gt;
            case expr of
                Z n -&gt;
                    Ok (Z n)

                F x -&gt;
                    Ok (F x)

                Sym s -&gt;
                    Ok (Sym s)

                L ((Sym functionName) :: args) -&gt;
                    dispatchFunction env functionName args

                L ((Lambda (L params) (L body)) :: args) -&gt;
                    evalResult env (applyLambdaToExpressionList params body args)

                L ((Lambda (L params) body) :: args) -&gt;
                    evalResult env (applyLambdaToExpression params body args)

                If (L boolExpr_) expr1 expr2 -&gt;
                    evalBoolExpr env boolExpr_ expr1 expr2

                L ((Str name) :: rest) -&gt;
                    Err &lt;| EvalError 0 (&quot;Unknown symbol: &quot; ++ name)

                L exprList_ -&gt;
                    Err &lt;| EvalError -1 &lt;| &quot;!!! &quot;

                _ -&gt;
                    Err &lt;| EvalError 0 &lt;| &quot;Missing case (eval), expr = XXX&quot;
</code></pre>
<p>Function <code>evalResult</code> matches the various patterns presented by
<code>expr</code>, mapping them to handlers which act on various subexpressions, returning a value of 
type <code>Result EvalError Expr</code>.  As an example, the pattern
<code>L ((Sym functionName) :: args)</code> is handle by the function call
<code>dispatchFunction env functionName args</code>, which operates by 
evaluating <code>arg</code> using the environment <code>env</code>, then applying
the function of type <code>List Expr -&gt; Result EvalError Expr</code> that it finds for the key <code>functionName</code>
in a suitable dictionary.</p>
<p>One more example: the function <code>applyLambdaToExpressionList</code>  creates a temporary frame with
bindings for the variable names and arguments of the 
lambda expression, then uses that frame to
resolve the names which appear in the function
body.  The result of this operation is then evaluated in the 
current environment by <code>evalResult</code>.</p>
<pre><code class="language-elm">applyLambdaToExpressionList : List Expr -&gt; List Expr -&gt; List Expr -&gt; Result EvalError Expr
applyLambdaToExpressionList params body args =
    let
        -- `A throw-away frame. It will never be used
        -- outside of this function.
        frameResult : Result Frame.FrameError Frame.Frame
        frameResult =
            Frame.addBindings (Frame.varNames params) args Frame.empty
    in
    case frameResult of
        Err frameError -&gt;
            Err frameError |&gt; Result.mapError (\err -&gt; FR err)

        Ok frame -&gt;
            Ok (List.map (Frame.resolve frame) body |&gt; L)        Ok (List.map (Frame.resolve frame) body |&gt; L)
</code></pre>
<p>The <code>Function</code> module exports built-in functions for
use by <code>eval</code>, e.g., <code>Function.plus</code> and <code>Function.times</code>.
To add a new function to MicroScheme, add an 
implementation of it to module <code>Function</code> and add its
name to <code>symbolStrings</code> in module <code>Init</code>.</p>
<h2 id="interpreter">Interpreter</h2>
<p>The interpreter is governed by the three functions</p>
<pre><code class="language-elm">init : State
input : String -&gt; State -&gt; State
step : State -&gt; State
</code></pre>
<p>where</p>
<pre><code class="language-elm">type alias State =
    { input : String
    , output : String
    , environment : Environment
    }
</code></pre>
<p>The function <code>init</code> returns a state in which
the input and output fields are empty strings
and the environment is a tree with one node, 
the <code>rootFrame</code>.  The root frame holds a dictionary
that maps strings to symbols, e.g., "+" to <code>Sym "+"</code>.</p>
<p>The function <code>input</code> accepts a strings and sets the
field <code>input</code> to it.</p>
<p>The function <code>step</code> runs the parse on <code>input</code>, 
runs <code>eval</code> on the result, and puts a string
version of the result in <code>output</code>.</p>
<h2 id="frames-and-environments">Frames and Environments</h2>
<p>A <em>frame</em> binds expressions to names:</p>
<pre><code class="language-elm">type alias Frame =
    { id : FrameId
    , bindings : Bindings
    }


type alias FrameId =
    Int


type alias Bindings =
    Dict String Expr
</code></pre>
<p>An <em>environment</em> is a tree of frames with a distinguished
(movable) node, i.e., a zipper:</p>
<pre><code class="language-elm">type alias Environment =
    Zipper Frame
</code></pre>
<h2 id="numbers">Numbers</h2>
<p>Module <code>Numbers</code> exports the type
<code>NumberError</code> and the functions <code>coerce</code> and <code>roundTo</code>.</p>
<pre><code class="language-elm">coerce : List Expr -&gt; Result NumberError (Either (List Int) (List Float))
</code></pre>
<ul>
<li>
<p>If the argument of <code>coerce</code> is a list of <code>Z Int</code>,
it returns  a <code>Left (List Int)</code> value.  </p>
</li>
<li>
<p>If it is 
a list o <code>F Float</code>, it returns a value of type
<code>Right (List Float)</code>.  </p>
</li>
<li>
<p>If it is a list of values of types
<code>Z Int</code> and <code>F Float</code>, it coerces the values 
of type <code>Z Int</code>to <code>Z Float</code> and returns a value
of type <code>Right (List Float)</code>. </p>
</li>
<li>
<p>In all other cases it return <code>Left NotAllNumbers</code></p>
</li>
</ul>
<p>The function call <code>roundTo 2 x</code> returns the value 
<code>x</code> rounded to two decicmals.</p>
<p><strong>Examples</strong></p>
<p><em>No coercion:</em></p>
<pre><code class="language-text">&gt; (+ 1 2)
3

&gt; (+ 1.003 2)
3.003

&gt; (+ 1.003 2.7)
3.7030000000000003
</code></pre>
<p>In the last case, floating point arithmetic produces
an incorrect result.  Better looking is the below</p>
<pre><code class="language-text">&gt; (roundTo 2 (+ 1.003 2.7))
3.7
</code></pre>
<p><em>Coercion:</em></p>
<pre><code class="language-text">&gt; (+ 1.1 2)
3.1
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../about/" class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../notes/" class="btn btn-neutral float-right" title="Notes">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../about/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../notes/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
